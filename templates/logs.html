<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Logs - Carbon IMS</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)),
                        url('/static/bg-forest.jpg') center/cover no-repeat fixed;
        }

        .container {
            max-width: none;
            width: 100%;
            height: 100vh;
            padding: 0;
            display: flex;
            align-items: stretch;
        }

        .logs-box {
            background: white;
            padding: 30px;
            width: 100%;
            height: 100vh;
            max-width: none;
            border-radius: 0;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .logs-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .logs-table {
            flex: 1;
            overflow: auto;
        }

        table {
            font-size: 13px;
            table-layout: auto;
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            padding: 10px 12px !important;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: left;
            font-weight: 600;
        }

        tbody td {
            padding: 8px 12px !important;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        .filter-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
            min-width: 140px;
        }

        .action-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .action-add { background: #d4edda; color: #155724; }
        .action-update { background: #fff3cd; color: #856404; }
        .action-delete { background: #f8d7da; color: #721c24; }
        .action-import { background: #d1ecf1; color: #0c5460; }
        .action-login { background: #e2e3e5; color: #383d41; }
        .action-logout { background: #e2e3e5; color: #383d41; }
        .action-revert { background: #cce5ff; color: #004085; }
        .action-restore { background: #d4edda; color: #155724; }

        .target-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            background: #e9ecef;
            color: #495057;
        }

        .status-reverted {
            background: #ffc107;
            color: #000;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }

        .status-active {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }

        .btn-undo {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-undo:hover {
            background: #c82333;
        }

        .btn-undo:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .btn-redo {
            background: #28a745;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-redo:hover {
            background: #218838;
        }

        .btn-redo:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .group-row {
            background: #f0f4ff;
            cursor: pointer;
        }

        .group-row:hover {
            background: #e0e8ff;
        }

        .group-icon {
            display: inline-block;
            width: 16px;
            transition: transform 0.2s;
        }

        .group-icon.expanded {
            transform: rotate(90deg);
        }

        .group-child {
            background: #fafafa;
        }

        .group-child.hidden {
            display: none;
        }

        .serial-range {
            font-family: monospace;
            font-size: 12px;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .btn-details {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-right: 5px;
        }

        .btn-details:hover {
            background: #138496;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            max-width: 700px;
            max-height: 80vh;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close {
            font-size: 28px;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #333;
        }

        .detail-row {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .detail-label {
            font-weight: 600;
            color: #495057;
            width: 140px;
            flex-shrink: 0;
        }

        .detail-value {
            color: #333;
            word-break: break-word;
        }

        .data-diff {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .data-diff h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #495057;
        }

        .data-diff pre {
            margin: 0;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .pagination-info {
            font-size: 13px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logs-box">
            <header class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1 style="margin: 0;">Activity Logs</h1>
                <div class="header-actions">
                    <a href="{{ url_for('auth.home') }}" class="btn-secondary">Back to Home</a>
                    <a href="{{ url_for('auth.logout') }}" class="btn-logout">Logout</a>
                </div>
            </header>

            <div class="logs-section">
                <div class="section-header">
                    <h2>System Activity Logs</h2>
                </div>

                <!-- Stats Bar -->
                <div class="stats-bar" id="statsBar">
                    <div class="stat-item">
                        <div class="stat-value" id="statTotal">-</div>
                        <div class="stat-label">Total Actions</div>
                    </div>
                    <div class="stat-item" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <div class="stat-value" id="statToday">-</div>
                        <div class="stat-label">Today</div>
                    </div>
                    <div class="stat-item" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);">
                        <div class="stat-value" id="statReverted">-</div>
                        <div class="stat-label">Undone</div>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="filter-section">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>User</label>
                            <select id="filterUser">
                                <option value="">All Users</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Action Type</label>
                            <select id="filterAction">
                                <option value="">All Actions</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Target Type</label>
                            <select id="filterTarget">
                                <option value="">All Targets</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Serial</label>
                            <input type="text" id="filterSerial" placeholder="Search serial...">
                        </div>
                        <div class="filter-group">
                            <label>Date From</label>
                            <input type="date" id="filterDateFrom">
                        </div>
                        <div class="filter-group">
                            <label>Date To</label>
                            <input type="date" id="filterDateTo">
                        </div>
                        <div class="filter-group">
                            <label>Status</label>
                            <select id="filterStatus">
                                <option value="">All</option>
                                <option value="active">Active Only</option>
                                <option value="reverted">Undone Only</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>&nbsp;</label>
                            <button class="btn-primary" onclick="applyFilters()">Apply Filters</button>
                        </div>
                        <div class="filter-group">
                            <label>&nbsp;</label>
                            <button class="btn-secondary" onclick="clearFilters()">Clear</button>
                        </div>
                    </div>
                </div>

                <!-- Logs Table -->
                <div class="logs-table">
                    <table id="logsTable">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Target</th>
                                <th>Serial</th>
                                <th>Details</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="logsBody">
                            <tr>
                                <td colspan="8" class="loading">
                                    <div class="spinner"></div>
                                    <p>Loading activity logs...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="pagination-controls">
                    <span class="pagination-info" id="paginationInfo">Showing 0 records</span>
                    <button class="btn-secondary" id="loadMoreBtn" onclick="loadMore()" style="display: none;">Load More</button>
                </div>
            </div>

            <!-- Log Detail Modal -->
            <div id="detailModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Log Details</h3>
                        <span class="close" onclick="closeDetailModal()">&times;</span>
                    </div>
                    <div class="modal-body" id="detailModalBody">
                        <!-- Details will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Undo Confirmation Modal -->
            <div id="undoModal" class="modal">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Confirm Undo</h3>
                        <span class="close" onclick="closeUndoModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <p style="color: #856404; background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <strong>Warning:</strong> This will undo the selected action and restore the previous state.
                        </p>
                        <div id="undoDetails"></div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button class="btn-secondary" onclick="closeUndoModal()">Cancel</button>
                            <button class="btn-undo" id="confirmUndoBtn" onclick="confirmUndo()">Undo Action</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Redo Confirmation Modal -->
            <div id="redoModal" class="modal">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Confirm Redo</h3>
                        <span class="close" onclick="closeRedoModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <p style="color: #155724; background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <strong>Info:</strong> This will re-apply the original action that was previously undone.
                        </p>
                        <div id="redoDetails"></div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button class="btn-secondary" onclick="closeRedoModal()">Cancel</button>
                            <button class="btn-redo" id="confirmRedoBtn" onclick="confirmRedo()">Redo Action</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alert Modal -->
            <div id="alertModal" class="modal">
                <div class="modal-content" style="max-width: 400px; text-align: center;">
                    <div class="modal-body">
                        <div id="alertIcon" style="font-size: 48px; margin-bottom: 15px;"></div>
                        <div id="alertMessage" style="font-size: 16px; margin-bottom: 20px;"></div>
                        <button class="btn-primary" onclick="closeAlertModal()">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="app-footer"></div>

    <script>
        const userRole = '{{ user_role }}';
        let allLogs = [];
        let groupedLogs = [];
        let expandedGroups = new Set();
        let currentOffset = 0;
        const pageSize = 100;
        let pendingUndoId = null;
        let pendingRedoId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadFilterOptions();
            loadLogs();
            loadStats();
        });

        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/logs/filters');
                const data = await response.json();

                if (data.success) {
                    // Populate user filter
                    const userSelect = document.getElementById('filterUser');
                    data.filters.usernames.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user;
                        option.textContent = user;
                        userSelect.appendChild(option);
                    });

                    // Populate action filter
                    const actionSelect = document.getElementById('filterAction');
                    data.filters.action_types.forEach(action => {
                        const option = document.createElement('option');
                        option.value = action;
                        option.textContent = action.charAt(0).toUpperCase() + action.slice(1);
                        actionSelect.appendChild(option);
                    });

                    // Populate target filter
                    const targetSelect = document.getElementById('filterTarget');
                    data.filters.target_types.forEach(target => {
                        const option = document.createElement('option');
                        option.value = target;
                        option.textContent = target.charAt(0).toUpperCase() + target.slice(1);
                        targetSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading filter options:', error);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/logs/stats');
                const data = await response.json();

                if (data.success && data.stats) {
                    document.getElementById('statTotal').textContent = data.stats.total || 0;
                    document.getElementById('statReverted').textContent = data.stats.reverted || 0;

                    // Calculate today's count from the logs
                    const today = new Date().toISOString().split('T')[0];
                    const todayLogs = allLogs.filter(log => log.created_at && log.created_at.startsWith(today));
                    document.getElementById('statToday').textContent = todayLogs.length;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadLogs(append = false) {
            try {
                if (!append) {
                    currentOffset = 0;
                    document.getElementById('logsBody').innerHTML = `
                        <tr>
                            <td colspan="8" class="loading">
                                <div class="spinner"></div>
                                <p>Loading activity logs...</p>
                            </td>
                        </tr>
                    `;
                }

                // Build query params
                const params = new URLSearchParams();
                params.append('limit', pageSize);
                params.append('offset', currentOffset);

                const user = document.getElementById('filterUser').value;
                const action = document.getElementById('filterAction').value;
                const target = document.getElementById('filterTarget').value;
                const serial = document.getElementById('filterSerial').value;
                const dateFrom = document.getElementById('filterDateFrom').value;
                const dateTo = document.getElementById('filterDateTo').value;
                const status = document.getElementById('filterStatus').value;

                if (user) params.append('username', user);
                if (action) params.append('action_type', action);
                if (target) params.append('target_type', target);
                if (serial) params.append('serial', serial);
                if (dateFrom) params.append('date_from', dateFrom);
                if (dateTo) params.append('date_to', dateTo);
                if (status === 'reverted') params.append('is_reverted', 'true');
                else if (status === 'active') params.append('is_reverted', 'false');

                const response = await fetch(`/api/logs?${params.toString()}`);
                const data = await response.json();

                if (data.success) {
                    if (append) {
                        allLogs = allLogs.concat(data.logs);
                    } else {
                        allLogs = data.logs;
                    }
                    groupedLogs = groupSequentialLogs(allLogs);
                    renderLogs();
                    updatePagination(data.count);

                    // Update today's stat
                    const today = new Date().toISOString().split('T')[0];
                    const todayLogs = allLogs.filter(log => log.created_at && log.created_at.startsWith(today));
                    document.getElementById('statToday').textContent = todayLogs.length;
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                document.getElementById('logsBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <h3>Error loading logs</h3>
                            <p>Please try refreshing the page.</p>
                        </td>
                    </tr>
                `;
            }
        }

        function groupSequentialLogs(logs) {
            if (!logs || logs.length === 0) return [];

            const groups = [];
            let currentGroup = null;

            for (const log of logs) {
                // Check if this log can be grouped with the current group
                if (currentGroup && canGroupWith(currentGroup, log)) {
                    currentGroup.logs.push(log);
                } else {
                    // Start a new group
                    if (currentGroup) {
                        groups.push(currentGroup);
                    }
                    currentGroup = {
                        id: `group_${log.id}`,
                        logs: [log],
                        action_type: log.action_type,
                        target_type: log.target_type,
                        username: log.username,
                        created_at: log.created_at
                    };
                }
            }

            // Don't forget the last group
            if (currentGroup) {
                groups.push(currentGroup);
            }

            return groups;
        }

        function canGroupWith(group, log) {
            // Must have same action type, target type, and username
            if (group.action_type !== log.action_type ||
                group.target_type !== log.target_type ||
                group.username !== log.username) {
                return false;
            }

            // Must be within 60 seconds of the first log in the group
            const groupTime = new Date(group.created_at + 'Z').getTime();
            const logTime = new Date(log.created_at + 'Z').getTime();
            if (Math.abs(groupTime - logTime) > 60000) {
                return false;
            }

            return true;
        }

        function getSerialRange(logs) {
            const serials = logs.map(l => l.serial).filter(s => s);
            if (serials.length === 0) return '-';
            if (serials.length === 1) return serials[0];

            // Sort serials and show range
            serials.sort();
            return `${serials[0]} ... ${serials[serials.length - 1]}`;
        }

        function renderLogs() {
            const tbody = document.getElementById('logsBody');

            if (groupedLogs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <h3>No activity logs found</h3>
                            <p>Activity will be recorded as users interact with the system.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';

            for (const group of groupedLogs) {
                if (group.logs.length === 1) {
                    // Single log, render normally
                    html += renderSingleLog(group.logs[0]);
                } else {
                    // Multiple logs, render as group
                    html += renderGroupHeader(group);
                    html += renderGroupChildren(group);
                }
            }

            tbody.innerHTML = html;
        }

        function renderSingleLog(log) {
            const timestamp = formatTimestamp(log.created_at);
            const actionClass = getActionClass(log.action_type);
            const canUndo = userRole === 'admin' && !log.is_reverted &&
                           ['add', 'update', 'delete'].includes(log.action_type) &&
                           ['inventory', 'warranty'].includes(log.target_type);
            const canRedo = userRole === 'admin' && log.is_reverted &&
                           ['add', 'update', 'delete'].includes(log.action_type) &&
                           ['inventory', 'warranty'].includes(log.target_type);

            return `
                <tr>
                    <td>${timestamp}</td>
                    <td>${log.username}</td>
                    <td><span class="action-badge ${actionClass}">${log.action_type}</span></td>
                    <td><span class="target-badge">${log.target_type}</span></td>
                    <td>${log.serial || '-'}</td>
                    <td title="${log.details || ''}">${truncate(log.details || '-', 50)}</td>
                    <td>
                        ${log.is_reverted
                            ? `<span class="status-reverted">UNDONE</span>`
                            : `<span class="status-active">ACTIVE</span>`}
                    </td>
                    <td>
                        <button class="btn-details" onclick="showDetails(${log.id})">Details</button>
                        ${canUndo ? `<button class="btn-undo" onclick="showUndoConfirm(${log.id})">Undo</button>` : ''}
                        ${canRedo ? `<button class="btn-redo" onclick="showRedoConfirm(${log.id})">Redo</button>` : ''}
                    </td>
                </tr>
            `;
        }

        function renderGroupHeader(group) {
            const timestamp = formatTimestamp(group.created_at);
            const actionClass = getActionClass(group.action_type);
            const isExpanded = expandedGroups.has(group.id);
            const serialRange = getSerialRange(group.logs);
            const count = group.logs.length;

            // Check if all logs in group can be undone/redone
            const allActive = group.logs.every(l => !l.is_reverted);
            const allReverted = group.logs.every(l => l.is_reverted);
            const canUndo = userRole === 'admin' && allActive &&
                           ['add', 'update', 'delete'].includes(group.action_type) &&
                           ['inventory', 'warranty'].includes(group.target_type);
            const canRedo = userRole === 'admin' && allReverted &&
                           ['add', 'update', 'delete'].includes(group.action_type) &&
                           ['inventory', 'warranty'].includes(group.target_type);

            const status = allReverted ? 'UNDONE' : (allActive ? 'ACTIVE' : 'MIXED');
            const statusClass = allReverted ? 'status-reverted' : (allActive ? 'status-active' : 'status-reverted');

            return `
                <tr class="group-row" onclick="toggleGroup('${group.id}')">
                    <td>
                        <span class="group-icon ${isExpanded ? 'expanded' : ''}">â–¶</span>
                        ${timestamp}
                    </td>
                    <td>${group.username}</td>
                    <td><span class="action-badge ${actionClass}">${group.action_type}</span></td>
                    <td><span class="target-badge">${group.target_type}</span></td>
                    <td><span class="serial-range">${count} items: ${serialRange}</span></td>
                    <td>Batch operation (${count} items)</td>
                    <td><span class="${statusClass}">${status}</span></td>
                    <td>
                        <button class="btn-details" onclick="event.stopPropagation(); showGroupDetails('${group.id}')">Details</button>
                        ${canUndo ? `<button class="btn-undo" onclick="event.stopPropagation(); showUndoGroupConfirm('${group.id}')">Undo All</button>` : ''}
                        ${canRedo ? `<button class="btn-redo" onclick="event.stopPropagation(); showRedoGroupConfirm('${group.id}')">Redo All</button>` : ''}
                    </td>
                </tr>
            `;
        }

        function renderGroupChildren(group) {
            const isExpanded = expandedGroups.has(group.id);
            let html = '';

            for (const log of group.logs) {
                const timestamp = formatTimestamp(log.created_at);
                const canUndo = userRole === 'admin' && !log.is_reverted &&
                               ['add', 'update', 'delete'].includes(log.action_type) &&
                               ['inventory', 'warranty'].includes(log.target_type);
                const canRedo = userRole === 'admin' && log.is_reverted &&
                               ['add', 'update', 'delete'].includes(log.action_type) &&
                               ['inventory', 'warranty'].includes(log.target_type);

                html += `
                    <tr class="group-child ${isExpanded ? '' : 'hidden'}" data-group="${group.id}">
                        <td style="padding-left: 30px;">${timestamp}</td>
                        <td>${log.username}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>${log.serial || '-'}</td>
                        <td title="${log.details || ''}">${truncate(log.details || '-', 50)}</td>
                        <td>
                            ${log.is_reverted
                                ? `<span class="status-reverted">UNDONE</span>`
                                : `<span class="status-active">ACTIVE</span>`}
                        </td>
                        <td>
                            <button class="btn-details" onclick="showDetails(${log.id})">Details</button>
                            ${canUndo ? `<button class="btn-undo" onclick="showUndoConfirm(${log.id})">Undo</button>` : ''}
                            ${canRedo ? `<button class="btn-redo" onclick="showRedoConfirm(${log.id})">Redo</button>` : ''}
                        </td>
                    </tr>
                `;
            }

            return html;
        }

        function toggleGroup(groupId) {
            if (expandedGroups.has(groupId)) {
                expandedGroups.delete(groupId);
            } else {
                expandedGroups.add(groupId);
            }
            renderLogs();
        }

        function formatTimestamp(ts) {
            if (!ts) return '-';
            try {
                const date = new Date(ts + 'Z'); // Assume UTC
                return date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch {
                return ts;
            }
        }

        function getActionClass(action) {
            const classes = {
                'add': 'action-add',
                'update': 'action-update',
                'delete': 'action-delete',
                'import': 'action-import',
                'login': 'action-login',
                'logout': 'action-logout',
                'revert': 'action-revert',
                'undo': 'action-revert',
                'redo': 'action-restore',
                'restore': 'action-restore'
            };
            return classes[action] || '';
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function updatePagination(count) {
            const info = document.getElementById('paginationInfo');
            const loadMoreBtn = document.getElementById('loadMoreBtn');

            info.textContent = `Showing ${allLogs.length} records`;

            if (count === pageSize) {
                loadMoreBtn.style.display = 'inline-block';
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }

        function loadMore() {
            currentOffset += pageSize;
            loadLogs(true);
        }

        function applyFilters() {
            loadLogs();
        }

        function clearFilters() {
            document.getElementById('filterUser').value = '';
            document.getElementById('filterAction').value = '';
            document.getElementById('filterTarget').value = '';
            document.getElementById('filterSerial').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterStatus').value = '';
            loadLogs();
        }

        async function showDetails(logId) {
            try {
                const response = await fetch(`/api/logs/${logId}`);
                const data = await response.json();

                if (data.success && data.log) {
                    const log = data.log;
                    const modal = document.getElementById('detailModal');
                    const body = document.getElementById('detailModalBody');

                    let html = `
                        <div class="detail-row">
                            <div class="detail-label">Log ID:</div>
                            <div class="detail-value">${log.id}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Timestamp:</div>
                            <div class="detail-value">${formatTimestamp(log.created_at)}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">User:</div>
                            <div class="detail-value">${log.username}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Action:</div>
                            <div class="detail-value"><span class="action-badge ${getActionClass(log.action_type)}">${log.action_type}</span></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Target Type:</div>
                            <div class="detail-value">${log.target_type}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Target ID:</div>
                            <div class="detail-value">${log.target_id || '-'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Serial:</div>
                            <div class="detail-value">${log.serial || '-'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Details:</div>
                            <div class="detail-value">${log.details || '-'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Status:</div>
                            <div class="detail-value">
                                ${log.is_reverted
                                    ? `<span class="status-reverted">UNDONE</span> by ${log.reverted_by} at ${formatTimestamp(log.reverted_at)}`
                                    : `<span class="status-active">ACTIVE</span>`}
                            </div>
                        </div>
                    `;

                    if (log.before_data) {
                        html += `
                            <div class="data-diff">
                                <h4>Before Data:</h4>
                                <pre>${JSON.stringify(log.before_data, null, 2)}</pre>
                            </div>
                        `;
                    }

                    if (log.after_data) {
                        html += `
                            <div class="data-diff">
                                <h4>After Data:</h4>
                                <pre>${JSON.stringify(log.after_data, null, 2)}</pre>
                            </div>
                        `;
                    }

                    body.innerHTML = html;
                    modal.style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading log details:', error);
                showAlert('Error loading log details', 'error');
            }
        }

        function showGroupDetails(groupId) {
            const group = groupedLogs.find(g => g.id === groupId);
            if (!group) return;

            const modal = document.getElementById('detailModal');
            const body = document.getElementById('detailModalBody');

            const serials = group.logs.map(l => l.serial).filter(s => s).join(', ');

            let html = `
                <div class="detail-row">
                    <div class="detail-label">Group Size:</div>
                    <div class="detail-value">${group.logs.length} items</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Timestamp:</div>
                    <div class="detail-value">${formatTimestamp(group.created_at)}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">User:</div>
                    <div class="detail-value">${group.username}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Action:</div>
                    <div class="detail-value"><span class="action-badge ${getActionClass(group.action_type)}">${group.action_type}</span></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Target Type:</div>
                    <div class="detail-value">${group.target_type}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Serials:</div>
                    <div class="detail-value" style="max-height: 200px; overflow-y: auto;">${serials || '-'}</div>
                </div>
            `;

            body.innerHTML = html;
            modal.style.display = 'flex';
        }

        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // Undo functions
        function showUndoConfirm(logId) {
            const log = allLogs.find(l => l.id === logId);
            if (!log) return;

            pendingUndoId = logId;

            const details = document.getElementById('undoDetails');
            details.innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">Action:</div>
                    <div class="detail-value"><span class="action-badge ${getActionClass(log.action_type)}">${log.action_type}</span></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Target:</div>
                    <div class="detail-value">${log.target_type}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Serial:</div>
                    <div class="detail-value">${log.serial || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Details:</div>
                    <div class="detail-value">${log.details || '-'}</div>
                </div>
            `;

            document.getElementById('undoModal').style.display = 'flex';
        }

        function showUndoGroupConfirm(groupId) {
            const group = groupedLogs.find(g => g.id === groupId);
            if (!group) return;

            pendingUndoId = group.logs.map(l => l.id);

            const details = document.getElementById('undoDetails');
            details.innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">Action:</div>
                    <div class="detail-value"><span class="action-badge ${getActionClass(group.action_type)}">${group.action_type}</span></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Target:</div>
                    <div class="detail-value">${group.target_type}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Items:</div>
                    <div class="detail-value">${group.logs.length} items will be undone</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Serials:</div>
                    <div class="detail-value">${getSerialRange(group.logs)}</div>
                </div>
            `;

            document.getElementById('undoModal').style.display = 'flex';
        }

        function closeUndoModal() {
            document.getElementById('undoModal').style.display = 'none';
            pendingUndoId = null;
        }

        async function confirmUndo() {
            if (!pendingUndoId) return;

            const btn = document.getElementById('confirmUndoBtn');
            btn.disabled = true;
            btn.textContent = 'Undoing...';

            try {
                const ids = Array.isArray(pendingUndoId) ? pendingUndoId : [pendingUndoId];
                let successCount = 0;
                let errorMsg = '';

                for (const id of ids) {
                    const response = await fetch(`/api/logs/revert/${id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const data = await response.json();
                    if (data.success) {
                        successCount++;
                    } else {
                        errorMsg = data.error || 'Failed to undo action';
                    }
                }

                closeUndoModal();
                if (successCount === ids.length) {
                    showAlert(`Successfully undone ${successCount} action(s)`, 'success');
                } else if (successCount > 0) {
                    showAlert(`Undone ${successCount}/${ids.length} actions. ${errorMsg}`, 'error');
                } else {
                    showAlert(errorMsg || 'Failed to undo action', 'error');
                }
                loadLogs();
                loadStats();
            } catch (error) {
                console.error('Error undoing action:', error);
                showAlert('Failed to undo action', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Undo Action';
            }
        }

        // Redo functions
        function showRedoConfirm(logId) {
            const log = allLogs.find(l => l.id === logId);
            if (!log) return;

            pendingRedoId = logId;

            const details = document.getElementById('redoDetails');
            details.innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">Action:</div>
                    <div class="detail-value"><span class="action-badge ${getActionClass(log.action_type)}">${log.action_type}</span></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Target:</div>
                    <div class="detail-value">${log.target_type}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Serial:</div>
                    <div class="detail-value">${log.serial || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Details:</div>
                    <div class="detail-value">${log.details || '-'}</div>
                </div>
            `;

            document.getElementById('redoModal').style.display = 'flex';
        }

        function showRedoGroupConfirm(groupId) {
            const group = groupedLogs.find(g => g.id === groupId);
            if (!group) return;

            pendingRedoId = group.logs.map(l => l.id);

            const details = document.getElementById('redoDetails');
            details.innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">Action:</div>
                    <div class="detail-value"><span class="action-badge ${getActionClass(group.action_type)}">${group.action_type}</span></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Target:</div>
                    <div class="detail-value">${group.target_type}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Items:</div>
                    <div class="detail-value">${group.logs.length} items will be redone</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Serials:</div>
                    <div class="detail-value">${getSerialRange(group.logs)}</div>
                </div>
            `;

            document.getElementById('redoModal').style.display = 'flex';
        }

        function closeRedoModal() {
            document.getElementById('redoModal').style.display = 'none';
            pendingRedoId = null;
        }

        async function confirmRedo() {
            if (!pendingRedoId) return;

            const btn = document.getElementById('confirmRedoBtn');
            btn.disabled = true;
            btn.textContent = 'Redoing...';

            try {
                const ids = Array.isArray(pendingRedoId) ? pendingRedoId : [pendingRedoId];
                let successCount = 0;
                let errorMsg = '';

                for (const id of ids) {
                    const response = await fetch(`/api/logs/redo/${id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const data = await response.json();
                    if (data.success) {
                        successCount++;
                    } else {
                        errorMsg = data.error || 'Failed to redo action';
                    }
                }

                closeRedoModal();
                if (successCount === ids.length) {
                    showAlert(`Successfully redone ${successCount} action(s)`, 'success');
                } else if (successCount > 0) {
                    showAlert(`Redone ${successCount}/${ids.length} actions. ${errorMsg}`, 'error');
                } else {
                    showAlert(errorMsg || 'Failed to redo action', 'error');
                }
                loadLogs();
                loadStats();
            } catch (error) {
                console.error('Error redoing action:', error);
                showAlert('Failed to redo action', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Redo Action';
            }
        }

        function showAlert(message, type) {
            const modal = document.getElementById('alertModal');
            const icon = document.getElementById('alertIcon');
            const msg = document.getElementById('alertMessage');

            icon.textContent = type === 'success' ? 'âœ“' : 'âœ•';
            icon.style.color = type === 'success' ? '#28a745' : '#dc3545';
            msg.textContent = message;
            modal.style.display = 'flex';
        }

        function closeAlertModal() {
            document.getElementById('alertModal').style.display = 'none';
        }

        // Close modals on outside click
        window.onclick = function(event) {
            const detailModal = document.getElementById('detailModal');
            const undoModal = document.getElementById('undoModal');
            const redoModal = document.getElementById('redoModal');
            const alertModal = document.getElementById('alertModal');

            if (event.target === detailModal) closeDetailModal();
            if (event.target === undoModal) closeUndoModal();
            if (event.target === redoModal) closeRedoModal();
            if (event.target === alertModal) closeAlertModal();
        };
    </script>
</body>
</html>
